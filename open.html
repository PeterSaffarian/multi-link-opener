<!doctype html>
<meta charset="utf-8">
<title>Opening client links…</title>
<script>
function parseUrls(search) {
  const p = new URLSearchParams(search || location.search);
  let urls = [];
  for (const [k,v] of p) if (k === "u") urls.push(v);
  if (!urls.length && p.get("all")) urls = p.get("all").split("|");
  urls = urls
    .map(decodeURIComponent)
    .map(u => u && (/^https?:\/\//i.test(u) ? u : `https://${u}`))
    .filter(Boolean);
  return [...new Set(urls)];
}

(function main() {
  const params = new URLSearchParams(location.search);
  const isChild = params.get("child") === "1";
  const urls = parseUrls(location.search);

  if (!urls.length) { document.body.textContent = "No URLs provided."; return; }

  if (!isChild) {
    // LAUNCHER — request a separate normal window (no popup features)
    const childUrl = new URL(location.href);
    childUrl.searchParams.set("child", "1");

    // Open as a new top-level window. Leaving the features string empty helps avoid "popup" treatment.
    const win = window.open(childUrl.toString(), "_blank", "");
    if (!win) { document.body.textContent = "Popup blocked. Allow pop-ups for this site and try again."; return; }

    // Close this launcher tab
    window.close();
    // Fallback message if close fails
    setTimeout(() => { try { if (!win.closed) document.body.textContent = "Opening your links…"; } catch(e){} }, 300);
    return;
  }

  // CHILD — we are now inside the new window.
  try {
    try { window.focus(); } catch(e) {}

    // Pre-create tabs INSIDE THIS WINDOW, then navigate them.
    // This pattern reliably keeps tabs in the current window on Chromium/Opera.
    const handles = [];
    for (let i = 1; i < urls.length; i++) {
      // Create about:blank tabs first
      handles[i] = window.open("about:blank", "_blank");
    }

    // Navigate the newly created tabs to their URLs (stagger to be safe)
    for (let i = 1; i < urls.length; i++) {
      const idx = i; // capture
      setTimeout(() => {
        try { if (handles[idx]) handles[idx].location = urls[idx]; } catch(e) {}
      }, i * 60);
    }

    // Finally, turn THIS window into the first URL (becomes tab #1)
    setTimeout(() => { location.replace(urls[0]); }, Math.max(30, urls.length * 60 - 30));
  } catch (e) {
    document.body.textContent = "Could not open all tabs. Allow pop-ups and try again.";
  }
})();
</script>
