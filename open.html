<!doctype html>
<meta charset="utf-8">
<title>Multi-Link Opener</title>
<p id="status">Preparing…</p>
<script>
const MAX=50, STEP=40;

function norm(u){
  u=(u||"").trim(); if(!u) return null;
  try{
    if(!/^[a-z][a-z0-9+.-]*:\/\//i.test(u)) u="https://"+u;
    const url=new URL(u), p=url.protocol.toLowerCase();
    if(p!=="http:" && p!=="https:") return null;
    return url.toString();
  }catch{ return null; }
}

function parseLinks(){
  const p=new URLSearchParams(location.search), out=[];
  const all=p.get("all");
  if(all) out.push(...all.split("|"));
  for(const [k,v] of p) if(k==="u") out.push(v);
  const seen=new Set(), clean=[];
  for(const raw of out){
    const n=norm(raw);
    if(n && !seen.has(n)){
      seen.add(n); clean.push(n);
      if(clean.length>=MAX) break;
    }
  }
  return clean;
}

(function main(){
  const s=document.getElementById("status");
  const links=parseLinks();
  if(!links.length){ s.textContent="No valid links."; return; }

  const isChild = new URLSearchParams(location.search).has("child");

  if(!isChild){
    // --- Launcher role ---
    const payload=encodeURIComponent(links.join("|"));
    const childUrl=`${location.pathname}?all=${payload}&child=1`;
    const child=window.open(childUrl,"multiLinkWin","noopener,noreferrer");
    if(child && !child.closed){
      s.textContent=`Opened a window for ${links.length} tab(s)…`;
    }else{
      // Fallback: open here if popup blocked
      s.textContent=`Popup blocked — opening in this window instead.`;
      links.forEach((link,i)=>setTimeout(
        ()=>window.open(link,"_blank","noopener,noreferrer"), STEP*i));
    }
  }else{
    // --- Child role: open tabs here ---
    let ok=0, blocked=0;
    links.forEach((link,i)=>setTimeout(()=>{
      const w=window.open(link,"_blank","noopener,noreferrer");
      (w && !w.closed) ? ok++ : blocked++;
      if(i===links.length-1){
        if(blocked===0) s.textContent=`Opened ${ok} tab(s).`;
        else if(ok===0) s.textContent="All pop-ups blocked.";
        else s.textContent=`${ok} opened, ${blocked} blocked.`;
        try{ window.close(); }catch{}
      }
    }, STEP*i));
  }
})();
</script>
