<!doctype html>
<meta charset="utf-8">
<title>Opening client links…</title>
<script>
function parseUrls(search) {
  const p = new URLSearchParams(search || location.search);
  let urls = [];
  for (const [k,v] of p) if (k === "u") urls.push(v);
  if (!urls.length && p.get("all")) urls = p.get("all").split("|");
  urls = urls
    .map(decodeURIComponent)
    .map(u => u && (/^https?:\/\//i.test(u) ? u : `https://${u}`))
    .filter(Boolean);
  return [...new Set(urls)];
}

(function main() {
  const params = new URLSearchParams(location.search);
  const isChild = params.get("child") === "1";
  const urls = parseUrls(location.search);

  if (!urls.length) {
    document.body.textContent = "No URLs provided.";
    return;
  }

  if (!isChild) {
    // LAUNCHER → open ONE *normal* window (with tab bar), not a popup
    const childUrl = new URL(location.href);
    childUrl.searchParams.set("child", "1");

    // No "popup" features; open as a standard window. Most Chromium builds
    // will give it a tab bar and treat subsequent window.open calls as tabs
    // in THIS window rather than the original one.
    const win = window.open(childUrl.toString(), "_blank"); // no features

    if (!win) {
      document.body.textContent = "Popup blocked. Allow pop-ups for this site and try again.";
      return;
    }
    document.body.textContent = "Opening your links…";
    return;
  }

  // CHILD → we're inside the new window. Make sure we're foregrounded.
  try {
    window.focus();

    // (a) Open remaining URLs as new tabs in THIS window.
    // Small delays help some Chromium builds associate the new tabs here.
    for (let i = 1; i < urls.length; i++) {
      try {
        setTimeout(() => { window.open(urls[i], "_blank"); }, i * 30);
      } catch (e) {}
    }

    // (b) Turn THIS window into the first URL (tab #1)
    setTimeout(() => { location.replace(urls[0]); }, 10);
  } catch (e) {
    document.body.textContent = "Could not open all tabs. Allow pop-ups and try again.";
  }
})();
</script>
