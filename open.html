<!doctype html>
<meta charset="utf-8">
<title>Opening client links…</title>
<script>
function parseUrls(search) {
  const p = new URLSearchParams(search || location.search);
  let urls = [];
  for (const [k,v] of p) if (k === "u") urls.push(v);
  if (!urls.length && p.get("all")) urls = p.get("all").split("|");
  urls = urls
    .map(decodeURIComponent)
    .map(u => u && (/^https?:\/\//i.test(u) ? u : `https://${u}`))
    .filter(Boolean);
  return [...new Set(urls)];
}

(function main() {
  const params = new URLSearchParams(location.search);
  const isChild = params.get("child") === "1";
  const urls = parseUrls(location.search);

  if (!urls.length) {
    document.body.textContent = "No URLs provided.";
    return;
  }

  if (!isChild) {
    // LAUNCHER — open ONE normal window (with tab bar), then close this tab
    const childUrl = new URL(location.href);
    childUrl.searchParams.set("child", "1");

    const win = window.open(childUrl.toString(), "_blank"); // no features => normal window
    if (!win) {
      document.body.textContent = "Popup blocked. Allow pop-ups for this site and try again.";
      return;
    }

    // Close the launcher tab (this one). Most browsers allow this since it was user-initiated.
    window.close();

    // Fallback message if close() is blocked
    setTimeout(() => {
      try { if (!win.closed) document.body.textContent = "Opening your links…"; } catch(e) {}
    }, 300);
    return;
  }

  // CHILD — we're in the new window
  try {
    window.focus();

    // Open remaining URLs as new tabs in THIS window (staggered helps Chromium)
    for (let i = 1; i < urls.length; i++) {
      setTimeout(() => { try { window.open(urls[i], "_blank"); } catch(e) {} }, i * 30);
    }

    // Make this window the first tab
    setTimeout(() => { location.replace(urls[0]); }, 10);
  } catch (e) {
    document.body.textContent = "Could not open all tabs. Allow pop-ups and try again.";
  }
})();
</script>
