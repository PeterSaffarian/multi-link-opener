<!doctype html>
<meta charset="utf-8">
<title>Opening client links…</title>
<script>
/* Parse ?u=...&u=... or ?all=url1|url2|url3 */
function parseUrls(search) {
  const p = new URLSearchParams(search || location.search);
  let urls = [];
  for (const [k, v] of p) if (k === "u") urls.push(v);
  if (!urls.length && p.get("all")) urls = p.get("all").split("|");
  urls = urls
    .map(decodeURIComponent)
    .map(u => u && (/^https?:\/\//i.test(u) ? u : `https://${u}`))
    .filter(Boolean);
  return [...new Set(urls)];
}

(function main() {
  const params = new URLSearchParams(location.search);
  const isChild = params.get("child") === "1";
  const urls = parseUrls(location.search);

  if (!urls.length) {
    document.body.textContent = "No URLs provided.";
    return;
  }

  if (!isChild) {
    // LAUNCHER (runs in the original tab opened from Airtable)
    // -> open ONE popup to our own page in child mode; the child will open all tabs.
    const childUrl = new URL(location.href);
    childUrl.searchParams.set("child", "1");         // mark as child
    const features = [
      "noopener",
      "noreferrer",
      "popup=yes",
      "toolbar=0,location=0,status=0,menubar=0,scrollbars=1",
      `width=${screen.availWidth}`, `height=${screen.availHeight}`
    ].join(",");

    const win = window.open(childUrl.toString(), "_blank", features);
    if (!win) {
      document.body.textContent = "Popup blocked. Please allow pop-ups for this site and try again.";
      return;
    }
    // Optional: close the launcher tab; comment this out if you prefer to keep it.
    window.close();
    document.body.textContent = "Opening your links…";
    return;
  }

  // CHILD (runs inside the popup)
  try {
    // Open remaining URLs as new tabs first…
    for (let i = 1; i < urls.length; i++) {
      try { window.open(urls[i], "_blank"); } catch (e) {}
    }
    // …then turn THIS popup into the first URL (so the new window hosts tab #1).
    location.replace(urls[0]);
  } catch (e) {
    document.body.textContent = "Could not open all tabs. Allow pop-ups and try again.";
  }
})();
</script>
